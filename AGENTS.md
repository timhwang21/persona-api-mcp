# Agent Development Guide

This document provides instructions for AI agents and developers working with the Persona API MCP (Model Context Protocol) server codebase.

## Architecture Overview

This is an MCP server that dynamically generates tools from the Persona API OpenAPI specification. The tools are **not statically defined** in the codebase but are generated at runtime from the OpenAPI spec.

## Key Concepts

### Dynamic Tool Generation

**Important**: Tools are dynamically generated from the OpenAPI specification, which means:

- ❌ **Don't** search for tool names like `inquiries_list` or `inquiry_create` in the codebase
- ❌ **Don't** expect to find tool implementations by grepping for tool names
- ✅ **Do** understand that tools are generated by the `ToolFactory` class
- ✅ **Do** look at the OpenAPI specification to understand available endpoints

### How Tool Generation Works

1. **OpenAPI Parsing**: The `OpenAPIParser` class loads and parses the OpenAPI specification
2. **Tool Factory**: The `ToolFactory` class generates MCP tools from OpenAPI operations
3. **Dynamic Registration**: Tools are registered with the MCP server at runtime

## Finding Tool Definitions

### Step 1: Check the OpenAPI Specification

The source of truth for all available tools is the OpenAPI specification:

```bash
# The OpenAPI spec is linked from persona-web
ls -la openapi/
# Points to: ../persona-web/openapi/external/openapi.yaml
```

### Step 2: Understand Tool Naming Convention

Tools are named using this pattern:
- `list-all-{resource}` → `{resource}_list`
- `create-an-{resource}` → `{resource}_create`  
- `retrieve-an-{resource}` → `{resource}_retrieve`
- `update-an-{resource}` → `{resource}_update`
- `delete-an-{resource}` → `{resource}_delete`

**Example**: `list-all-inquiries` becomes `inquiries_list`

### Step 3: Tool Generation Logic

Look at these files to understand tool generation:

```typescript
// Tool naming logic
src/tools/generators/tool-factory.ts:generateToolName()

// Tool generation from OpenAPI operations  
src/tools/generators/tool-factory.ts:generateToolsForTag()

// OpenAPI parsing
src/tools/generators/openapi-parser.ts
```

### Step 4: Runtime Tool Registration

Generated tools are registered here:

```typescript
// Tool initialization
src/tools/inquiry/generated.ts:initializeInquiryTools()

// MCP server tool registration
src/server/mcp-server.ts
```

## Development Workflow

### Adding New Tools

To add support for new API endpoints:

1. **Update OpenAPI Spec**: Add the new endpoints to the OpenAPI specification in persona-web
2. **No Code Changes Needed**: Tools will be automatically generated
3. **Test**: Restart the MCP server to pick up new tools

### Modifying Tool Behavior

To modify how tools work:

1. **Tool Factory**: Modify `src/tools/generators/tool-factory.ts`
2. **API Client**: Update `src/api/client.ts` if API interaction changes
3. **Tool Templates**: Modify tool generation templates in the factory

### Debugging Tools

To debug tool issues:

```bash
# Check what tools are generated
npm start
# Look at the logs to see registered tools

# Check OpenAPI parsing
node -e "
const { openAPIParser } = require('./dist/tools/generators/openapi-parser.js');
openAPIParser.loadAPI().then(api => console.log(JSON.stringify(api, null, 2)));
"
```

## File Structure

```
src/
├── tools/
│   ├── generators/           # Tool generation logic
│   │   ├── tool-factory.ts   # Main tool generation
│   │   └── openapi-parser.ts # OpenAPI specification parsing
│   └── inquiry/
│       ├── generated.ts      # Generated inquiry tools
│       └── create.ts         # Manual tool implementations (if any)
├── server/
│   └── mcp-server.ts        # MCP server with tool registration
├── api/
│   └── client.ts            # Persona API client
└── utils/
    ├── config.ts            # Configuration management
    └── logger.ts            # Logging utilities
```

## Common Patterns

### Searching for Tool Logic

```bash
# ❌ Don't do this (won't find anything)
grep -r "inquiries_list" src/

# ✅ Do this instead
grep -r "generateToolName" src/
grep -r "generateToolsForTag" src/
```

### Finding API Integration

```bash
# Look for API client methods
grep -r "personaAPI" src/

# Check API configuration
grep -r "PERSONA_API" src/
```

### Understanding Tool Execution

```bash
# Tool execution flow
grep -r "executeInquiryTool" src/

# MCP request handling  
grep -r "tools/call" src/
```

## Environment Setup

### Required Environment Variables

```bash
# .env file
PERSONA_API_KEY=your_api_key_here
PERSONA_API_URL=http://localhost:3000/api/v1
NODE_ENV=development
```

### Development Commands

```bash
# Install dependencies
npm install

# Build the project
npm run build

# Run tests
npm test

# Start the MCP server
npm start

# Development with auto-rebuild
npm run dev
```

## Testing Strategy

### Unit Tests

Tests focus on:
- Tool generation logic
- Configuration validation
- MCP protocol compliance
- Error handling

```bash
# Run all tests
npm test

# Run specific test file
npx vitest src/tools/generators/tool-factory.test.ts
```

### Integration Testing

To test the full MCP integration:

1. Start the server: `npm start`
2. Connect Claude with MCP configuration
3. Test tool execution through Claude

## Troubleshooting

### Tool Not Found

If a tool isn't available:

1. Check if the endpoint exists in the OpenAPI spec
2. Verify the tool naming convention
3. Check server logs for generation errors
4. Ensure the OpenAPI symlink is correct

### MCP Connection Issues

Common issues:
- Environment variables not loaded (check dotenv configuration)
- Tool naming mismatches (check `generateToolName` logic)
- Parameter destructuring errors (check request validation)

### OpenAPI Symlink Issues

```bash
# Check symlink
ls -la openapi/
# Should point to: ../persona-web/openapi/external

# Recreate if needed
rm openapi
ln -s ../persona-web/openapi/external openapi
```

## Best Practices

1. **Always check the OpenAPI spec first** when investigating tool behavior
2. **Use the generated tools** rather than creating manual implementations
3. **Test tool changes** by restarting the MCP server
4. **Follow the established naming conventions** for consistency
5. **Use the logging system** to debug tool execution
6. **Keep the OpenAPI spec in sync** with the actual API

## Resources

- [MCP SDK Documentation](https://github.com/modelcontextprotocol/typescript-sdk)
- [OpenAPI Specification](https://swagger.io/specification/)
- [Persona API Documentation](../persona-web/README.md)